# Portal de Cadastro de Desembargos - IDAF

## Requisitos
- Node 	(versão recomendada: 18.x)
- npm 	(versão recomendada: 9.2.0)
- PostgreSQL (versão recomendada: 15.x)

## Preparativos

1. Instalar as dependências do Node rodando o seguinte comando na pasta `./backend`:

												`npm install`
  

2. Adicionar o arquivo `.env` na pasta `./backend`, preenchendo-o com as informações relativas ao banco de dados, à porta que a aplicação vai ser executada, a senha secreta da aplicação e a URL da API de login. Siga conforme o exemplo a seguir e o arquivo em `./backend/.env.example`
```
DB_HOST=ipDoBancoDeDados
DB_PORT=portaDoBancoDeDados
DB_NAME=nomeDaDatabase
DB_USER=usuarioDoBancoDeDados
DB_PASS=senhaDoBancoDeDados
PORT=portaDaAplicacao
SECRET=senhaSecretDaAplicacao
MAPPIA_DB_URL=urlDaAPIMappiaDB
MAPPIA_IS_GERENTE_QUERY=requestDaAPIParaGerente
MAPPIA_IS_COMUM_QUERY=requestDaAPIParaComum
SCHEMA=schemaNoBancoDeDados
USER_TABLE=tabelaDeUsuariosNoBancoDeDados
DESEMBARGO_TABLE=tabelaDeDesembargosNoBancoDeDados
EMBARGO_TABLE=tabelaDeEmbargosNoBancoDeDados
USER_LOG_TABLE=tabelaDeLogDeUsuarios
```

3. A estrutura utilizada (em PostgreSQL) para as tabelas no BD nos ambientes de teste estão dispostas a seguir. Lembre-se de alterar `SCHEMA` para o schema definido no `.env`, bem como o nome das tabelas.


- Tabela de Usuários:

```
CREATE TABLE SCHEMA.USERS_TEST(
	ID BIGINT GENERATED ALWAYS AS IDENTITY,
	USERNAME TEXT PRIMARY KEY,
	NAME TEXT,
	POSITION TEXT,
	CREATED_AT TIMESTAMPTZ DEFAULT NOW()
);
```

- Tabela de Desembargos:

```
CREATE TABLE IF NOT EXISTS SCHEMA.DESEMBARGOS_TESTE (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  numero_ano TEXT,
  numero_embargo INTEGER,
  serie_embargo CHAR,
  processo_simlam TEXT,
  numero_sep BIGINT,
  numero_edocs TEXT,
  coordenada_x DOUBLE PRECISION,
  coordenada_y DOUBLE PRECISION,
  nome_autuado TEXT,
  area_desembargada DOUBLE PRECISION,
  tipo_desembargo TEXT CHECK (tipo_desembargo IN ('TOTAL','PARCIAL','INDEFERIMENTO')),
  data_desembargo DATE,
  responsavel_desembargo TEXT NOT NULL,
  descricao TEXT,
  status TEXT CHECK (status IN ('APROVADO','EM ANÁLISE','REVISÃO PENDENTE')),
  aprovado_por TEXT
);
```
  
- Tabela de Log de Usuários:
```
CREATE TABLE SCHEMA.LOG_TESTE(
	ID BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
	USERNAME TEXT,
	ACTION TEXT,
	DETAILS JSONB,
	IP INET,
	USER_AGENT TEXT,
	CREATED_AT TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

- Tabela de Embargos:

```
CREATE TABLE SCHEMA.EMBARGOS_TESTE(
	N_UIF_EMB INTEGER,
	NORTHING DOUBLE PRECISION,
	EASTING DOUBLE PRECISION,
	PROCESSO TEXT,
	SEP_EDOCS TEXT,
	GEOM GEOMETRY
);
```

- Tabela de Registro Sequencial separado por Ano:
```
CREATE TABLE IF NOT EXISTS _desembargo.desembargo_year_seq (
  ano INTEGER PRIMARY KEY,
  last_seq INTEGER NOT NULL DEFAULT 0
);
```
- Essa tabela existe para que, sempre que um desembargo for criado, associar ao campo `numero_ano` dele um número incremental único concatenado ao ano corrente.

### Script para criação do Trigger que preenche o `numero_ano` a cada inserção de desembargo

```
-- cria a função auxiliar
CREATE OR REPLACE FUNCTION SCHEMA.gen_numero_ano_if_null()
RETURNS trigger
LANGUAGE plpgsql
AS $$
DECLARE
  v_year INTEGER := EXTRACT(YEAR FROM CURRENT_DATE)::INTEGER;
  v_last INTEGER;
  v_newseq INTEGER;
BEGIN
  -- se já vier com numero_ano preenchido, não mexe
  IF NEW.numero_ano IS NOT NULL AND trim(NEW.numero_ano) <> '' THEN
    RETURN NEW;
  END IF;

  -- bloqueia a linha do ano (ou detecta que não existe)
  SELECT last_seq INTO v_last
  FROM SCHEMA.desembargo_year_seq
  WHERE ano = v_year
  FOR UPDATE;

  IF NOT FOUND THEN
    v_newseq := 1;
    INSERT INTO SCHEMA.desembargo_year_seq(ano, last_seq) VALUES (v_year, v_newseq);
  ELSE
    v_newseq := v_last + 1;
    UPDATE SCHEMA.desembargo_year_seq SET last_seq = v_newseq WHERE ano = v_year;
  END IF;

  -- atribui "N-YYYY" — N sem zero-padding. Troque aqui para lpad(v_newseq::text,3,'0') se quiser padding.
  NEW.numero_ano := v_newseq::text || '-' || v_year::text;

  RETURN NEW;
END;
$$;

-- trigger que executa antes do insert que chama a função para cada linha
DROP TRIGGER IF EXISTS trg_gen_numero_ano_if_null ON SCHEMA.desembargos_teste;
CREATE TRIGGER trg_gen_numero_ano_if_null
BEFORE INSERT ON SCHEMA.desembargos_teste
FOR EACH ROW
EXECUTE FUNCTION SCHEMA.gen_numero_ano_if_null();
```

## Execução

Para executar o backend, basta estar na pasta `./backend` e executar o seguinte comando:

												`npm start`

Note que o servidor será executado na porta definida no arquivo `.env`, e o acesso ao endereço `localhost:PORTA`, substituindo PORTA pelo valor definido no `.env`, redirecionará ao site.