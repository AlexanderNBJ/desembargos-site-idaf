<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeloVerde ES - Área Técnica</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.png">
    <link rel="stylesheet" href="css/stylesHeader.css">
    <link rel="stylesheet" href="css/stylesList.css">

</head>
<body>
    <header class="top-bar">
        <div class="logo">
            <!-- Logo em SVG -->
            <img src="assets/simbolo-seloverde.svg" alt="Logo Selo Verde">
        </div>
        <div class="title-text">
            <h1>SeloVerde ES - Área Técnica</h1>
            <h2>Formulário de Cadastro de Desembargos</h2>
            <span class="restricted-badge">Área Restrita</span>
        </div>
        <div class="logout-container">
            <button id="logoutBtn" class="logout-btn" aria-label="Logout" title="Sair">Logout</button>
        </div>
    </header>
    <div class="page-container" role="main">

  <div class="list-header" aria-hidden="false">
    <h3 class="list-title">Lista de desembargos:</h3>

    <div class="search-wrapper" title="Pesquisar desembargos">
      <!-- magnifier icon -->
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
        <path fill="#666" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM9.5 14A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14z"/>
      </svg>

      <input id="search" type="search" placeholder="Pesquisar..." aria-label="Pesquisar desembargos">
    </div>
  </div>

  <div class="table-card" role="region" aria-label="Lista de desembargos">
    <table class="desembargos" role="table" aria-label="Tabela de desembargos">
      <thead>
        <tr>
          <th class="col-termo">Termo de Embargo</th>
          <th class="col-processo">Processo Simlam</th>
          <th class="col-sep">SEP</th>
          <th class="col-edocs">e-Docs</th>
          <th class="col-autuado">Autuado</th>
          <th class="col-tipo">Tipo</th>
          <th class="col-area">Área Desembargada</th>
          <th class="col-responsavel">Responsável pelo desembargo</th>
          <th class="col-data">Data de Desembargo</th>
          <th class="col-acoes">Ações</th>
        </tr>
      </thead>

      <tbody id="desembargos-list">
        <!-- placeholder rows (exemplo estático) -->
        <tr>
          <td class="col-termo">123456 A</td>
          <td class="col-processo">12345/2025</td>
          <td class="col-sep">12345678</td>
          <td class="col-edocs">2025-AA123</td>
          <td class="col-autuado">João Silva</td>
          <td class="col-tipo muted">TOTAL</td>
          <td class="col-area muted">0,5 ha</td>
          <td class="col-responsavel">Miguel Santos</td>
          <td class="col-data">07/08/2025</td>
          <td class="col-acoes">
            <div class="actions" aria-hidden="true">
              <!-- lupa -->
              <button class="action-btn" title="Visualizar">
                <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM9.5 14A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14z"></path>
                </svg>
              </button>
              <!-- editar -->
              <button class="action-btn" title="Editar">
                <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.41l-2.34-2.34a1.003 1.003 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path>
                </svg>
              </button>
              <!-- documento / copiar -->
              <button class="action-btn" title="Gerar PDF">
                <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM13 3.5L18.5 9H13V3.5zM6 20V4h6v5h5v11H6z"></path>
                </svg>
              </button>
            </div>
          </td>
        </tr>

        <!-- repita exemplo para visual -->
        <tr>
          <td>123456 A</td>
          <td>12345/2025</td>
          <td>12345678</td>
          <td>2025-AA123</td>
          <td>João Silva</td>
          <td class="muted">TOTAL</td>
          <td class="muted">0,5 ha</td>
          <td>Miguel Santos</td>
          <td>07/08/2025</td>
          <td>
            <div class="actions">
              <button class="action-btn" title="Visualizar">
                <svg class="icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM9.5 14A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14z"/></svg>
              </button>
              <button class="action-btn" title="Editar">
                <svg class="icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.41l-2.34-2.34a1.003 1.003 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
              </button>
              <button class="action-btn" title="Gerar PDF">
                <svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM13 3.5L18.5 9H13V3.5zM6 20V4h6v5h5v11H6z"/></svg>
              </button>
            </div>
          </td>
        </tr>

      </tbody>
    </table>
  </div>

  <!-- template para uso via JS: clone this template and populate before appending to #desembargos-list -->
  <template id="row-template">
    <tr>
      <td class="col-termo">{{termo}}</td>
      <td class="col-processo">{{processo}}</td>
      <td class="col-sep">{{sep}}</td>
      <td class="col-edocs">{{edocs}}</td>
      <td class="col-autuado">{{autuado}}</td>
      <td class="col-tipo muted">{{tipo}}</td>
      <td class="col-area muted">{{area}}</td>
      <td class="col-responsavel">{{responsavel}}</td>
      <td class="col-data">{{data}}</td>
      <td class="col-acoes">
        <div class="actions">
          <button class="action-btn" data-action="view" title="Visualizar">...</button>
          <button class="action-btn" data-action="edit" title="Editar">...</button>
          <button class="action-btn" data-action="pdf" title="Gerar PDF">...</button>
        </div>
      </td>
    </tr>
  </template>

</div>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const token = localStorage.getItem('token');
  const tbody = document.getElementById('desembargos-list');
  const template = document.getElementById('row-template').content;
  const searchInput = document.getElementById('search');

  // formata data dd/mm/yyyy
  function formatDate(isoDate) {
    if (!isoDate) return '';
    const d = new Date(isoDate);
    return d.toLocaleDateString('pt-BR');
  }

  // busca desembargos do backend
  async function fetchDesembargos(searchTerm = '') {
    try {
      const url = `/api/desembargos/list${searchTerm ? '?search=' + encodeURIComponent(searchTerm) : ''}`;
      const res = await fetch(url, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.message || 'Erro ao buscar desembargos');
      return data.data;
    } catch (err) {
      console.error(err);
      return [];
    }
  }

  // renderiza tabela
  function renderTable(data) {
    tbody.innerHTML = '';
    data.forEach(d => {
      const clone = document.importNode(template, true);
      clone.querySelector('.col-termo').textContent = d.termo;
      clone.querySelector('.col-processo').textContent = d.simlam;
      clone.querySelector('.col-sep').textContent = d.sep || '';
      clone.querySelector('.col-edocs').textContent = d.edocs || '';
      clone.querySelector('.col-autuado').textContent = d.autuado;
      clone.querySelector('.col-tipo').textContent = d.tipo;
      clone.querySelector('.col-area').textContent = d.area ? `${d.area} ha` : '';
      clone.querySelector('.col-responsavel').textContent = d.responsavel;
      clone.querySelector('.col-data').textContent = formatDate(d.data);

      const actions = clone.querySelectorAll('.action-btn');
      actions.forEach(btn => {
        const action = btn.dataset.action;
        btn.addEventListener('click', () => handleAction(action, d));
      });

      tbody.appendChild(clone);
    });
  }

  // actions
  function handleAction(action, desembargo) {
    switch(action) {
      case 'view': alert(`Visualizar: ${desembargo.termo}`); break;
      case 'edit': alert(`Editar: ${desembargo.termo}`); break;
      case 'pdf': alert(`Gerar PDF: ${desembargo.termo}`); break;
    }
  }

  // busca inicial
  renderTable(await fetchDesembargos());

  // debounce helper
  function debounce(fn, delay) {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn(...args), delay);
    };
  }

  // live search
  searchInput.addEventListener('input', debounce(async () => {
    const term = searchInput.value.trim();
    const resultados = await fetchDesembargos(term);
    renderTable(resultados);
  }, 300));
});
</script>

</body>
</html>